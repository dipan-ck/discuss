

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum ChannelType {
  TEXT
  VOICE
}


model User {
  id          String          @id @default(cuid())
  username    String          @unique
  email       String         @unique
  password    String
  createdAt   DateTime        @default(now())
  
  // Relations
  ownedServers  Server[]       @relation("ServerOwner")
  memberships   ServerMember[]
  messages      Message[]
}

model Server {
  id          String          @id @default(cuid())
  name        String
  ownerId     String
  createdAt   DateTime        @default(now())

  // Relations
  owner       User            @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     ServerMember[]
  channels    Channel[]
}

model ServerMember {
  id          String   @id @default(cuid())
  serverId    String
  userId      String
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())

  // Relations
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([serverId, userId]) 
}

model Channel {
  id          String   @id @default(cuid())
  serverId    String
  name        String
  type        ChannelType @default(TEXT)
  createdAt   DateTime @default(now())

  // Relations
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  messages    Message[]
}


model Message {
  id          String   @id @default(cuid())
  channelId   String
  userId      String
  content     String
  createdAt   DateTime @default(now())
  editedAt    DateTime?

  // Relations
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@index([channelId, createdAt])       // very important for scrolling/pagination
  @@index([userId, createdAt])
}
